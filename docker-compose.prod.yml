# Production Configuration
# Use with: docker-compose -f docker-compose.yml -f docker-compose.monitoring.yml -f docker-compose.prod.yml up
# Security hardened, resource constrained, logging configured

version: '3.8'

services:
  api:
    # Production-only ports (reverse proxy should handle HTTPS)
    ports:
      - "127.0.0.1:8000:8000"  # Only localhost - use nginx/traefik for public access
    
    # Production environment
    environment:
      - LOG_LEVEL=WARNING
      - METRICS_REQUIRE_AUTH=true  # MUST be true in production
      - WORKERS=4  # Multiple workers for production
    
    # Security hardening
    security_opt:
      - no-new-privileges:true
    read_only: true  # Filesystem is read-only
    tmpfs:
      - /tmp
      - /app/.cache
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    
    # Production resource limits (adjust based on your instance)
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          cpus: '2.0'
          memory: 4G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "production,api"
    
    # Stricter health checks
    healthcheck:
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 90s

  prometheus:
    # Don't expose publicly in production
    # Access via internal network or VPN only
    ports: []  # Remove all port mappings
    
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
    cap_drop:
      - ALL
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  alertmanager:
    ports: []  # No public access
    
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
    cap_drop:
      - ALL
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  grafana:
    # Access via reverse proxy only
    ports: []
    
    environment:
      # Enforce strong password
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}  # Must be set in .env
      - GF_SECURITY_DISABLE_GRAVATAR=true
      - GF_SECURITY_COOKIE_SECURE=true
      - GF_SECURITY_COOKIE_SAMESITE=strict
      - GF_SECURITY_STRICT_TRANSPORT_SECURITY=true
      - GF_LOG_LEVEL=warn
    
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp
    cap_drop:
      - ALL
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
